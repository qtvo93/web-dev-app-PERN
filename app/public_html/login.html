<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>Log in</title>
</head>
<body>

<h1>My Cool Site</h1>
<div id="tobe">
<h2>Log in</h2>

<div>
	<div>
		<label name="username" for="username">Username:</label>
		<input type="text" id="username">
	</div>
	<div>
		<label name="password" for="password">Password:</label>
		<input type="password" id="password">
	</div>
</div>

<button id="login">Log in</button>

<p><a href="create.html">Need an account?</a></p>
</div>
	<div id = "user"></div>
	<div id = "message"></div>
	<div id = "createTasks"></div>
	<table>
		<tr><th>Task Pending</th>
		<tbody id="tasksPending"></tbody>
	</table>
	<table>
		<th>Task Done</th></tr>
		<tbody id="tasksDone"></tbody>
	</table>
<script>

let user = document.getElementById("user");
let tobe = document.getElementById("tobe");
let button = document.getElementById("createTasks");
let messageBox = document.getElementById("message");
let tablePending= document.getElementById("tasksPending");	
let tableDone= document.getElementById("tasksDone");	
let usernameInput = document.getElementById("username");
let passwordInput = document.getElementById("password");

function removeChildren(element) {
	while (element.hasChildNodes()) {
		element.lastChild.remove();
	}
}

document.getElementById("login").addEventListener("click", function () {
	fetch("/auth", {
		method: "POST",
		headers: {
			"Content-Type": "application/json"
		},
		body: JSON.stringify({
			username: usernameInput.value,
			plaintextPassword: passwordInput.value,
		})
	}).then(function (response) {
		if (response.status === 200) {
			var input = document.createElement("input");
			input.type = "text";
			button.append(input);
			let buttonCreate = document.createElement("button");
			buttonCreate.textContent = "Create Task";
			buttonCreate.addEventListener("click", function () {
			//console.log(input.value);
				fetch("/add", {
					method: "POST",
					headers: {
						"Content-Type": "application/json"
					},
					body: JSON.stringify({
						username: usernameInput.value,
						task: input.value,
						status: 0,
					})
				})
			})
			buttonCreate.addEventListener("click", function () {
				console.log(usernameInput.value);
				let requestURL = `/add?username=${usernameInput.value}`;
				fetch(requestURL).then(function (response) {
					if (response.status === 200) {
						return response.json();
					} else {
						throw Error(response.status);
					}
				}).then(function (response) {
					if (!response.rows.length){
						messageBox.textContent =  "No users found";
					} else {
						let row = response.rows[0];
						let tasks = row["tasks"];
						let status = row["status"];
						
						let tableRow = document.createElement("tr");
						tableRow.onclick = function () {
							fetch("/update", {
								method: "POST",
								headers: {
									"Content-Type": "application/json"
								},
								body: JSON.stringify({
									username: usernameInput.value,
									task: tasks[tasks.length -1]
								})
							})
						};
						let cell = document.createElement("td");
						cell.textContent = tasks[tasks.length -1];
						tableRow.append(cell);
						if(status[status.length - 1]) {
							tableDone.append(tableRow);
							cell.style.textDecoration = "underline";
						} else {
							tablePending.append(tableRow);;
						}
		
						messageBox.textContent = "";
					}
				}).catch(function (error) {
					console.log(error);
				});
			})
			button.append(buttonCreate);
			tobe.textContent = "";
			return response.json();
		} else {
			removeChildren(tableBody);
			throw Error(response.status);
		}
		
	}).then(function (response) {
		if (!response.rows.length){
			messageBox.textContent =  "No users found";
		} else {
			//user.textContent = usernameInput.value;
			removeChildren(tableDone);
			removeChildren(tablePending);
			tobe.textContent = "username: " + response.rows[0]["username"];
			//console.log(response.rows);
			let row = response.rows[0];
			let tasks = row["tasks"];
			let status = row["status"];
            
			for (let i=0; i < tasks.length; i++) {
				let tableRow = document.createElement("tr");
				tableRow.onclick = function () {
							fetch("/update", {
								method: "POST",
								headers: {
									"Content-Type": "application/json"
								},
								body: JSON.stringify({
									username: usernameInput.value,
									task: tasks[i]
								})
							})
						};
                let cell = document.createElement("td");
                cell.textContent = tasks[i];
				tableRow.append(cell);
				if(status[i]) {
					tableDone.append(tableRow);
					cell.style.textDecoration = "underline";
				} else {
					tablePending.append(tableRow);
				}
			}
			
			messageBox.textContent = "";
		}
	}).catch(function (error) {
		console.log(error);
	});
});

</script>

</body>
</html>